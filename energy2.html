<!doctype html>
<!-- change launch button to pause button (clear the timeouts)
 allow to resume launch after pause 
 allow speed up or slow down
 -->


<html>
<head>
<title>Energy</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta charset='UTF-8' />
<script src='js/jsvgplot.js'></script>
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Chivo:ital,wght@0,400;0,900;1,400;1,900&family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">

<script type='text/javascript'>
/* START ENERGY BAR FUNCTIONS */
function energyInit(id) {
	//if ( param == undefined ) { var param = {}; }
	let svg = document.getElementById(id);
	let param = {'coordsRange':[0,-30,13,30]};	
	coords = new createCoords(id,{'coordsRange':param['coordsRange'],'clip':false,'margin':['3rem','2rem','6rem','2rem']});
	let xpts = [1,3,4,6,7,9,10,12];
	coords.plotAxis('x',{'minorNx':0,'grid':false,'xpts':xpts,'xaxisLabelsShow':false,'showX0':true},{},{'stroke':'black','stroke-width':5});
	
	let dU = (coords.u(3)-coords.u(2))/144+0.5
	let dy = -0.25;	
	let textStyle = {'font-size':(4*dU)+'rem','dominant-baseline':'hanging','text-align':'center'};

	coords.plotText('KE',{'x':2,'y':dy,'append':coords.svg.g2},textStyle);
	coords.plotText('PE',{'x':5,'y':dy,'append':coords.svg.g2},textStyle);
	coords.plotText('OE',{'x':8,'y':dy,'append':coords.svg.g2},textStyle);
	coords.plotText('E',{'x':11,'y':dy,'append':coords.svg.g2},textStyle);
	
	
	//plotEnergy(true);
}

function plotEnergy(init) {
	let KE,PE,OE,E,h,KEbar,PEbar,OEbar,Ebar;
	
	KE = document.getElementById('KEinput').value*1;
	PE = document.getElementById('PEinput').value*1;
	OE = document.getElementById('OEinput').value*1;
	E = document.getElementById('Einput').value*1;
	
	if( init != undefined ? init : false ) {
		coords.plotObject('rect',{'x':1,'y':0,'width':2,'height':KE},{'fill':'blue','opacity':0.65,'id':'KEbar'});
		coords.plotObject('rect',{'x':4,'y':0,'width':2,'height':PE},{'fill':'red','opacity':0.65,'id':'PEbar'});
		coords.plotObject('rect',{'x':7,'y':0,'width':2,'height':OE},{'fill':'green','opacity':0.65,'id':'OEbar'});
	}
	else {
		setBar('KE');
		setBar('PE');
		setBar('OE');
	}
	
	// redraw the E bars	
	if( document.getElementById('Eopt2').checked == true ) {
		if( document.getElementById('E0bar') != undefined ) { document.getElementById('E0bar').remove(); }
		if( document.getElementById('E1bar') != undefined ) { 
			document.getElementById('E1bar').remove(); 
			document.getElementById('E2bar').remove(); 
			document.getElementById('E3bar').remove(); 
		} 
		coords.plotObject('rect',{'x':10,'y':0,'width':2,'height':KE},{'fill':'blue','opacity':0.65,'id':'E1bar'});
		coords.plotObject('rect',{'x':10,'y':KE,'width':2,'height':PE},{'fill':'red','opacity':0.65,'id':'E2bar'});
		coords.plotObject('rect',{'x':10,'y':KE+PE,'width':2,'height':OE},{'fill':'green','opacity':0.65,'id':'E3bar'});
		
	} else {
		if( document.getElementById('E1bar') != undefined ) { document.getElementById('E1bar').remove(); }
		if( document.getElementById('E2bar') != undefined ) { document.getElementById('E2bar').remove(); }
		if( document.getElementById('E3bar') != undefined ) { document.getElementById('E3bar').remove(); }
		if( document.getElementById('E0bar') != undefined ) { /* setBar('E0'); */ }
		else { coords.plotObject('rect',{'x':10,'y':0,'width':2,'height':E},{'fill':'black','opacity':0.65,'id':'E0bar'}); }	
	}
	
	if( document.getElementById('KEtext') != undefined ) { document.getElementById('KEtext').remove(); }
	if( document.getElementById('PEtext') != undefined ) { document.getElementById('PEtext').remove(); }
	if( document.getElementById('OEtext') != undefined ) { document.getElementById('OEtext').remove(); }
	if( document.getElementById('Etext') != undefined ) { document.getElementById('Etext').remove(); }
	
	if( document.getElementById('Eopt1').checked == true ) {
		let textStyle,KEtxt,PEtxt,OEtxt,Etxt;	
		let dU = (coords.u(3)-coords.u(1))/144;
		let dy = 0.2*dU;		
		textStyle = {'dominant-baseline':'bottom','font-size':(3*dU)+'rem','opacity':0.75};
		KEtxt = (KE/10).toFixed(2)+'E';
		PEtxt = (PE/10).toFixed(2)+'E';
		OEtxt = (OE/10).toFixed(2)+'E';
		Etxt = 'E';

		coords.plotText( KEtxt ,{'x':2,'y':KE*1,'dy':dy},Object.assign({'stroke':'blue','id':'KEtext'},textStyle));
		coords.plotText( PEtxt ,{'x':5,'y':PE*1,'dy':dy},Object.assign({'stroke':'red','id':'PEtext'},textStyle));
		coords.plotText( OEtxt ,{'x':8,'y':OE*1,'dy':dy},Object.assign({'stroke':'green','id':'OEtext'},textStyle));
		coords.plotText('E',{'x':11,'y':E*1,'dy':dy},Object.assign({'stroke':'black','id':'Etext'},textStyle));
	}
}

function setBar(id,val,y0) {
	if( y0 == undefined ) { var y0 = 0; }
	if( val == undefined ) { val = document.getElementById(id+'input').value*1; }
	let	bar = document.getElementById(id+'bar');
	
	bar.setAttribute('y',coords.v(val));
	bar.setAttribute('height',Math.abs(coords.v(y0)-coords.v(val)));
	
	let txt,x;
	let textStyle = {'dominant-baseline':'bottom','font-size':'3rem','opacity':0.75};
	if( document.getElementById(id+'txt') != undefined ) { document.getElementById(id+'txt').remove(); }
	if( id == 'KE' ) { x = 2; textStyle['stroke'] = 'blue'; }
	else if ( id == 'PE' ) { x = 5; textStyle['stroke'] = 'red'; }
	else if ( id == 'OE' ) { x = 8; textStyle['stroke'] = 'green'; }
	document.getElementById(id+'input').value = val*1;
}
/* END ENERGY BAR FUNCTIONS */


/* PROJECT PLOT FUNCTIONS */
let coords2, ball_dr = 0.2;
function physicsInit(id) {
	let svg = document.getElementById(id);
	let param = {'coordsRange':[-10,0,10,30]};	
	coords2 = new createCoords(id,{'coordsRange':param['coordsRange'],'clip':false,'margin':[0,0,0,0]});
	coords2.plotObject('circle',{'cx':0,'cy':0,'r':5},{'fill':'green'});
	coords2.plotObject('circle',{'cx':0,'cy':5-ball_dr,'r':.2},{'fill':'red','stroke':'black','id':'projectile'});
}

var ticktock,ticktock2;
function animateProjectile() {
	// check state launch, pause, resume
	let state = document.getElementById('launchbutton');
	let y0Input,v0Input,yInput,vInput;
	y0Input = document.getElementById('y0Input');
	v0Input = document.getElementById('v0Input');
	yInput = document.getElementById('yInput');
	vInput = document.getElementById('vInput');
	
	let GM,v0,R0,R,ve,r,t,tr,param;
	GM = 1E4;
	R0 = 5;
	ve = Math.sqrt(2*GM/R0);
	v0 = 0.9*ve;
	R = R0/(1-v0*v0/(ve*ve));
	tr = Math.sqrt(R/GM)*(R0*Math.sqrt(R/R0-1)+R*Math.atan(Math.sqrt(R/R0-1)));
	param = {'GM':GM,'R0':R0,'v0':v0};
	
	// GIVEN the parameters create arrays of r,t,v,a values
	let i = 0; N = 10000;
	let rArr = new Array();
	let tArr = new Array();
	let vArr = new Array();
	let aArr = new Array();
	
	for( i = 0; i <= 2*N; i++ ) {
		if( i < N ) {
			r = R0+(R-R0)*i/N;
			t = tr - Math.sqrt(R/GM)*(r*Math.sqrt(R/r-1)+R*Math.atan(Math.sqrt(R/r-1)));
			v = Math.sqrt(GM/R*(R/r-1));
		} else {
			r = R0+(R-R0)*(2*N-i)/N;
			t = tr + Math.sqrt(R/GM)*(r*Math.sqrt(R/r-1)+R*Math.atan(Math.sqrt(R/r-1)));
			v = -Math.sqrt(GM/R*(R/r-1));		
		}
		rArr[i] = r;
		tArr[i] = t;
		vArr[i] = v;
	}	
	aArr = spline(tArr,rArr,v0,0); // get the acceleration of the projectile via spline

	let ball = document.getElementById('projectile');
	let t1 = 0,t2 = 2*tr, j = 0, dt = 5;
	
	let n = 1000;
	if( r == 5 ) { impact(); }
	for( i = 0; i <= n; i++ ) {
		ticktock = window.setTimeout( function (){
			t = t1+j*(t2-t1)/n;
			r = splint(t,tArr,rArr,aArr)-ball_dr;
			ball.setAttribute('cy',coords2.v(r));
			v = Math.sqrt(GM/R*(R/r-1));
			yInput.value=r;
			vInput.value=v;		
			/*
			PE = E*y/h; 
			KE = E-PE;
			OE = 0;	
			document.getElementById('KEinput').value = KE.toFixed(2);
			document.getElementById('PEinput').value = PE.toFixed(2);
			document.getElementById('OEinput').value = OE.toFixed(2);
			plotEnergy(); */
			j++
		},i*dt);
	}
	
	ticktock2 = window.setTimeout( function (){
		yInput.value = y0Input.value;
		vInput.value = v0Input.value;
		state.value = 0;
		state.innerHTML = 'launch';
		if( !document.getElementById('Eopt3').checked ) {
			document.getElementById('KEinput').value = 0;
			document.getElementById('PEinput').value = 0;
			//document.getElementById('OEinput').value = E.toFixed(2);
			//plotEnergy();
			impact();
		}
	},n*dt);
}


function impact() {
	let r0 = 4.6 	;
	let d = 'M 0 '+r0+' ',r,r1 = 1, r2 = 0.6*r1, x,y, q = 45/4*Math.PI/180, dy;
	dy = coords2.height/coords2.width;
	for( let i = -1; i < 18; i++ ) {
		r = (i%2 == 0) ? r1 : r2; 
		x = -r*Math.cos(i*q); y = r0+r*dy/2*Math.sin(i*q);
		d += 'L '+x+' '+y+' ';
	}
	d+='Z';
	coords2.plotObject('path',{'d':d},{'class':'fadeout'});
}

function spline(xN,yN,dy0,dyn) {
    /*  takes a function with an array of xN values and an array of yN vales and returns [x,y,ddy]
      dy0 and dyn are the first derivatives at the boundary, assumed 0 unless specified
      uses modified numerical recipes code, solve a triadiagonal array */
  var n = xN.length - 1;
  var u = new Array();
  var ddy = new Array();

  // assume "natural" boundary conditions if the point isn't specified
  if( !dy0 ) { ddy[0] = u[0] = 0; }
	else { u[0] = dy0; ddy[0] = 0; }

  var i,p,sig;
  for( i = 1; i<n; i++ ) {
    sig = (xN[i]-xN[i-1])/(xN[i+1]-xN[i-1]);
    p = sig*ddy[i-1]+2;
    ddy[i] = (sig-1)/p;
    u[i] = (yN[i+1]-yN[i])/(xN[i+1]-xN[i]) - (yN[i]-yN[i-1])/(xN[i]-xN[i-1]);
    u[i] = 6*u[i]/(xN[i+1]-xN[i-1]) - sig*u[i-1]/p;
  }

  // assume "natural" boundary conditions if the point isn't specified  
  if( !dyn ) { ddy[n] = u[n] = 0; }

  // backsubstitution loop of the tridiagonal algorithm
  for( i=n-1;i>=0;i-- ) {
    ddy[i] = ddy[i]*ddy[i+1]+u[i];
  }
  return ddy;
}

function splint(x,xN,yN,ddy) {
  /*  takes an array of xN values, yN values, and the second derivatives (calculated via the spline function)
    returns the cubic spline interpolation of y(x) */
  var i = 0; // min value
  var j = xN.length; // max value
  var k;
  
  while( j-i > 1 ) {
    k = Math.round( (i+j)/2 );
    if ( x < xN[k] ) { j = k; }
    else { i = k; }
  }
  if ( j-i == 0 ) { alert("Something bad happened."); }
  
  if(x=xN[i]) { return yN[i]; }
  if(y=yN[j]) { return yN[j]; }

  var A = (xN[i+1]-x)/(xN[i+1]-xN[i]);
  var B = 1 - A;
  var C = (A*A*A-A)*(xN[i+1]-xN[i])*(xN[i+1]-xN[i])/6;
  var D = (B*B*B-B)*(xN[i+1]-xN[i])*(xN[i+1]-xN[i])/6;
  
  var y = A*yN[i]+B*yN[i+1]+C*ddy[i]+D*ddy[i+1];  
  return y;
}

/* END PROJECTILE FUNCTIONS */
</script>

<style type='text/css'>
body { font-family: Chiva; margin: 0; padding: 0; }
svg { display: block; height: 100vh; width: 100%; }

#container { 
	display: grid;
	grid-template-columns: 1fr auto 1fr auto 1fr;
}
.gridcol { background-color: rgba(0,0,0,0.5); }

#svgcontainer { width: clamp(400px,60vw,1000px); }
#controlscontainer { width: clamp(200px,20vw,400px); }

#physicsscene { width: 100%; height: 80vh; margin-bottom: 1rem; }

#controlscontainer > p { width: clamp(9rem,12rem,100%); margin: 0 auto; }
#controlscontainer > p > button { display: block; margin-top: 0.5rem; }


.fadeout {
	stroke: red; fill: gold;
	opacity: 0;
  animation-duration: 0.25s;
  animation-name: fadeOut;
}

@keyframes fadeOut {
  from { opacity: 100%; }
  to { opacity: 0%; }
}

button { width: 5rem; margin-left: 1rem; }

</style>   
</head>

<body>
<div id='container'>

<div class='gridcol'></div>

<div id='svgcontainer'>
<svg id='energysvg' onload='energyInit(this.id);' viewport='0 0 1000 1000'></svg>
</div>

<div class='gridcol' style='min-width: 10px;'></div>

<div id='controlscontainer'>
<svg id='physicsscene' onload='physicsInit(this.id);'></svg>
<input type='hidden' id='KEinput' value='0'/>
<input type='hidden' id='PEinput' value='0'/>
<input type='hidden' id='OEinput' value='0'/>
<input type='hidden' id='Einput' value='-0.9025'/>
<input type='hidden' id='y0Input' value='5'/>
<input type='hidden' id='yInput' value='5'/>
<input type='hidden' id='v0Input' value='55'/>
<input type='hidden' id='vInput' value='0'/>


<p><input type='checkbox' id='Eopt1' checked onchange='plotEnergy();'/> Show values</p>
<p><input type='checkbox' id='Eopt2' onchange='plotEnergy();'/> Split E column</p>
<p><input type='checkbox' id='Eopt3' onchange='plotEnergy();'/> Pause before impact</p>
<p><button id='launchbutton' value='0' onclick='animateProjectile();'>launch</button></p>
</div>

<div class='gridcol'></div>

</div>

</body>
</html>